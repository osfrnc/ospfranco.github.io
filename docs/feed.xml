<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.3">Jekyll</generator><link href="https://ospfranco.com/feed.xml" rel="self" type="application/atom+xml" /><link href="https://ospfranco.com/" rel="alternate" type="text/html" /><updated>2024-04-29T11:10:59+02:00</updated><id>https://ospfranco.com/feed.xml</id><title type="html">Oscar Franco</title><author><name>Oscar Franco</name></author><entry><title type="html">Why Swift is better than Rust</title><link href="https://ospfranco.com/why-swift-is-better-than-rust/" rel="alternate" type="text/html" title="Why Swift is better than Rust" /><published>2024-04-29T00:00:00+02:00</published><updated>2024-04-29T00:00:00+02:00</updated><id>https://ospfranco.com/why%20swift%20is%20better%20than%20rust</id><content type="html" xml:base="https://ospfranco.com/why-swift-is-better-than-rust/"><![CDATA[<p>Over the last year, I have been building software in native languages. C++, Swift, Kotlin and most recently Rust. Rust has been particularly tricky to get right and has given me an uneasy feeling.</p>

<h1 id="solving-memory-management">Solving memory management</h1>

<p>The big promise of Rust is to prevent memory allocation problems. It does this via the Borrow Checker which forces you to avoid leaky patterns from the get-go. The problem is that the borrow checker forces you to write manually safe code ALL THE TIME. Some of my thoughts are expressed at length in this recent <a href="https://loglog.games/blog/leaving-rust-gamedev/#rust-being-great-at-big-refactorings-solves-a-largely-self-inflicted-issues-with-the-borrow-checker">Rust article</a> that is making the rounds on the internet:</p>

<blockquote>
  <p>The most fundamental issue is that the borrow checker forces a refactor at the most inconvenient times. Rust users consider this to be a positive, because it makes them “write good code”, but the more time I spend with the language the more I doubt how much of this is true. Good code is written by iterating on an idea and trying things out, and while the borrow checker can force more iterations, that does not mean that this is a desirable way to write code. I’ve often found that being unable to just move on for now and solve my problem and fix it later was what was truly hurting my ability to write good code.</p>
</blockquote>

<p>While the specific use-case of writing Rust games may not be ideal for such a strict system as the borrow-checker I have found the tyrannical nature of it more cumbersome than helpful. On my normal day-to-day, there are very few pieces of code where I want to write the memory-safe code myself. Opening a file, and passing a variable to multiple functions, everything becomes 20x cumbersome.</p>

<p>The borrow-checker on a high level, dumps the responsibility of writing safe code to YOU. It’s a very useful helper but it just points at the correct path and doesn’t solve the problem.</p>

<h1 id="swift-has-become-my-favorite-language">Swift has become my favorite language</h1>

<p>After the last few years, I can only praise Swift. It’s not perfect, but it feels like the culmination of the C-like family of languages. It does a lot of the nice things Rust does. Explicit control, and exhaustive checks for branching code, yet it has dynamic syntax. But it also does them with automatic memory management.</p>

<p>Swift has taken all the lessons of the last 20 years of software development and dumped them into a useful language.</p>

<h1 id="the-feeling">The feeling</h1>

<p>Whenever I open a Swift file I wrote myself I can immediately pick up where I left. Whereas with Rust every function is a mess of <code class="language-plaintext highlighter-rouge">unwrap</code>, <code class="language-plaintext highlighter-rouge">clone</code>, <code class="language-plaintext highlighter-rouge">arc</code>, <code class="language-plaintext highlighter-rouge">box</code>. Ultimately, Rust solved the memory management problem at the interface between your hands and the keyboard and that makes coding too hard.</p>

<p>I don’t think Swift is perfect but is a joy to work with.</p>]]></content><author><name>Oscar Franco</name></author><category term="post" /><summary type="html"><![CDATA[Over the last year, I have been building software in native languages. C++, Swift, Kotlin and most recently Rust. Rust has been particularly tricky to get right and has given me an uneasy feeling.]]></summary></entry><entry><title type="html">How to resolve duplicated libraries on Android</title><link href="https://ospfranco.com/how-to-resolve-duplicated-libraries-on-android/" rel="alternate" type="text/html" title="How to resolve duplicated libraries on Android" /><published>2023-12-07T00:00:00+01:00</published><updated>2023-12-07T00:00:00+01:00</updated><id>https://ospfranco.com/how%20to%20resolve%20duplicated%20libraries%20on%20android</id><content type="html" xml:base="https://ospfranco.com/how-to-resolve-duplicated-libraries-on-android/"><![CDATA[<p>If you have developed on Android long enough, you might have found an error like this:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>A failure occurred <span class="k">while </span>executing com.android.build.gradle.internal.tasks.MergeNativeLibsTask<span class="nv">$MergeNativeLibsTaskWorkAction</span>
2 files found with path <span class="s1">'lib/arm64-v8a/libcrypto.so'</span>
</code></pre></div></div>

<p>This is caused by two libraries/dependencies generating the same artifact (in this case, depending on OpenSSL which generates <code class="language-plaintext highlighter-rouge">libcrypto.so</code>). If you haven’t declared your dependency on OpenSSL, then the problem is a transitive dependency (you require A and B, and both require C).</p>

<p>There are a number of workarounds, but they all have potential issues, so here are some short explanations.</p>

<h1 id="exclude">Exclude</h1>

<p>The first solution you might try is the <code class="language-plaintext highlighter-rouge">exclude</code> command of gradle. This will only work if you are modifying the sources of one of the conflicting libraries. This basically tells Gradle: whenever you are packaging this library, exclude this files from the final bundle merge.</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">packagingOptions</span> <span class="o">{</span>
      <span class="n">excludes</span> <span class="o">=</span> <span class="o">[</span>
        <span class="c1">// ... other excluded files</span>
        <span class="s2">"**/libcrypto.so"</span>
      <span class="o">]</span>
<span class="o">}</span>
</code></pre></div></div>

<p>This will basically force your final application to contain one <code class="language-plaintext highlighter-rouge">libcrypto.so</code> and avoid any potential conflicts. The problem is than, if you remove the other dependency and no one is left to generate the .so, then you are out of luck and you will get an error saying the file is missing.</p>

<h1 id="pick-first">Pick first</h1>

<p>Another possible strategy is using <code class="language-plaintext highlighter-rouge">pickFirst</code>, it basically tells Gradle: “whatever you find first, just link against that”. The problem with this however is that it cannot be included in the offending library <code class="language-plaintext highlighter-rouge">build.gradle</code> but must be specified in the application’s <code class="language-plaintext highlighter-rouge">build.gradle</code> (since that is the parent scope that faces the conflict when compiling the dependencies)</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">packagingOptions</span> <span class="o">{</span>
  <span class="n">pickFirst</span> <span class="s1">'**/libcrypto.so'</span>
<span class="o">}</span>
</code></pre></div></div>

<h1 id="other-strategies">Other strategies</h1>

<p>There are other strategies that work on pure gradle dependencies, which might or might not work on React Native but you can give them a try.</p>

<h2 id="excluding-group">Excluding group</h2>

<p>Change the declared dependency to exclude the internal dependency</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">implementation</span> <span class="o">(</span><span class="s1">'junit:junit:4.12'</span><span class="o">){</span>
    <span class="n">exclude</span> <span class="nl">group:</span> <span class="s1">'org.hamcrest'</span><span class="o">,</span> <span class="nl">module:</span><span class="s1">'hamcrest-core'</span> <span class="c1">// exclude the transtive dependency</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="explicitely-requiring-the-dependency">Explicitely requiring the dependency</h2>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">implementation</span> <span class="s1">'junit:junit:4.12'</span>
<span class="n">implementation</span> <span class="s1">'org.hamcrest:hamcrest-core:1.3'</span> <span class="c1">// force the shared dependency version</span>
</code></pre></div></div>

<h2 id="force-resolution">Force resolution</h2>

<p>This might force an older version into the dependencies</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">android</span> <span class="o">{</span>
    <span class="n">configurations</span><span class="o">.</span><span class="na">all</span> <span class="o">{</span>
        <span class="n">resolutionStrategy</span><span class="o">.</span><span class="na">force</span> <span class="s1">'org.hamcrest:hamcrest-core:1.1'</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h1 id="version-missmatch">Version missmatch</h1>

<p>The problem with this solutions is that you are forcing a single version upon your dependencies, which might break because they might rely on the API of a particular version. I don’t know how to include two versions of the same library unfortunately, so the actual solution is to make sure you are on the latest versions and they all depend on the same transitive dependency version.</p>]]></content><author><name>Oscar Franco</name></author><category term="post" /><summary type="html"><![CDATA[If you have developed on Android long enough, you might have found an error like this:]]></summary></entry><entry><title type="html">Mix C++, Obj-C and Swift files in a single XCode target</title><link href="https://ospfranco.com/post/2023/11/24/mix-c++,-obj-c-and-swift-files-in-a-single-xcode-target/" rel="alternate" type="text/html" title="Mix C++, Obj-C and Swift files in a single XCode target" /><published>2023-11-24T00:00:00+01:00</published><updated>2023-11-24T00:00:00+01:00</updated><id>https://ospfranco.com/post/2023/11/24/mix%20c++,%20obj-c%20and%20swift%20files%20in%20a%20single%20xcode%20target</id><content type="html" xml:base="https://ospfranco.com/post/2023/11/24/mix-c++,-obj-c-and-swift-files-in-a-single-xcode-target/"><![CDATA[<p>If you have an XCode project where you are trying to mix C++, Obj-C and Swift, things will not work. If you only deal with Obj-C++ everything compiles fine, but the moment you add Swift into the mix you might start getting a slew of errors on your header files.</p>

<p>The root issue is the <a href="https://stackoverflow.com/questions/47788422/cannot-use-namespace-and-cannot-include-standard-c-library-in-my-h-files">Swift compiler</a>, it doesn’t support C++, yet it still tries to compile C headers on its own. Whenever you have Swift files together with C++ files, it’s the Swift compiler that will kick-in in a first pass (followed by CLang? maybe before? doesn’t matter) and will try to compile the headers as C headers independently of what you tell it, file extensions, etc.</p>

<p>You will then start getting errors based on the C++ syntax (if you used any). For example if you are using namespaces (which don’t exist on C), you will get <a href="https://github.com/CocoaPods/CocoaPods/issues/12105#issuecomment-1824455557">invalid syntax errors</a>.</p>

<p>There are a couple workarounds. First you can wrap every single bit of C++ syntax in your headers around a macro that checks if the compiler supports C++:</p>

<pre><code class="language-C++">#if defined __cplusplus
extern "C" {
#endif

#if defiend __cplusplus

class Foo
{
    void bar(int c);
}
#endif
struct FooHandle;

void Foo_bar(struct FooHandle* foo, int c);

#if defined __cplusplus
}
#endif
</code></pre>

<p>Every header you create you will have to manually modify to check for syntax errors.</p>

<h1 id="cocoapods">Cocoapods</h1>

<p>Cocoapods has a special problem with this, since it generates an umbrella header that will also get compiled by the Swift compiler and it will fail. Either of the methods described above will workaround the issue for now.</p>

<p>Another alternative is to hide the header files from the XCode file system, yet still provide them via flags that will get passed to the compilers:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"json"</span>

<span class="n">package</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">__dir__</span><span class="p">,</span> <span class="s2">"package.json"</span><span class="p">)))</span>

<span class="no">Pod</span><span class="o">::</span><span class="no">Spec</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">name</span>           <span class="o">=</span> <span class="s2">"matrix"</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">version</span>        <span class="o">=</span> <span class="n">package</span><span class="p">[</span><span class="s2">"version"</span><span class="p">]</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">summary</span>        <span class="o">=</span> <span class="n">package</span><span class="p">[</span><span class="s2">"description"</span><span class="p">]</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">homepage</span>       <span class="o">=</span> <span class="n">package</span><span class="p">[</span><span class="s2">"homepage"</span><span class="p">]</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">license</span>        <span class="o">=</span> <span class="n">package</span><span class="p">[</span><span class="s2">"license"</span><span class="p">]</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">authors</span>        <span class="o">=</span> <span class="n">package</span><span class="p">[</span><span class="s2">"author"</span><span class="p">]</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">platforms</span>      <span class="o">=</span> <span class="p">{</span> <span class="ss">:ios</span> <span class="o">=&gt;</span> <span class="s2">"13.0"</span> <span class="p">}</span>

  <span class="n">s</span><span class="p">.</span><span class="nf">pod_target_xcconfig</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"DEFINES_MODULE"</span> <span class="o">=&gt;</span> <span class="s2">"YES"</span><span class="p">,</span>
    <span class="s2">"SWIFT_COMPILATION_MODE"</span> <span class="o">=&gt;</span> <span class="s2">"wholemodule"</span><span class="p">,</span>
    <span class="s2">"CLANG_CXX_LANGUAGE_STANDARD"</span> <span class="o">=&gt;</span> <span class="s2">"c++17"</span><span class="p">,</span>
    <span class="c1"># ↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span>
    <span class="s2">"HEADER_SEARCH_PATHS"</span> <span class="o">=&gt;</span> <span class="s2">"</span><span class="se">\"</span><span class="s2">$(PODS_TARGET_SRCROOT)/cpp/</span><span class="se">\"</span><span class="s2">/** "</span> <span class="c1"># This will link the headers at compile time, flag passed directly to the compiler</span>
  <span class="p">}</span>

  <span class="c1"># ↓↓↓↓↓↓↓↓↓↓↓↓</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">source_files</span> <span class="o">=</span> <span class="s2">"ios/**/*.{mm,swift}"</span><span class="p">,</span> <span class="s2">"cpp/**/*.{cpp,c}"</span> <span class="c1"># Do not include the headers in the sources, then XCode won't try to compile them</span>

  <span class="c1"># ↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">preserve_paths</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"cpp/**/*.h"</span><span class="p">,</span>
    <span class="s2">"ios/**/*.h"</span>
  <span class="p">]</span>

  <span class="n">s</span><span class="p">.</span><span class="nf">dependency</span> <span class="s2">"React"</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">dependency</span> <span class="s2">"React-Core"</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">dependency</span> <span class="s2">"React-callinvoker"</span>
<span class="k">end</span>
</code></pre></div></div>

<p>One side effect is that the headers will not appear on the project explorer view on XCode, which is annoying if you are developing something from scratch, you can still ⌘ + click to open it, but it won’t show navigation side bar.</p>]]></content><author><name>Oscar Franco</name></author><category term="post" /><summary type="html"><![CDATA[If you have an XCode project where you are trying to mix C++, Obj-C and Swift, things will not work. If you only deal with Obj-C++ everything compiles fine, but the moment you add Swift into the mix you might start getting a slew of errors on your header files.]]></summary></entry><entry><title type="html">Swift 5.9 Notes</title><link href="https://ospfranco.com/swift-5.9-notes/" rel="alternate" type="text/html" title="Swift 5.9 Notes" /><published>2023-11-24T00:00:00+01:00</published><updated>2023-11-24T00:00:00+01:00</updated><id>https://ospfranco.com/swift%205.9%20notes</id><content type="html" xml:base="https://ospfranco.com/swift-5.9-notes/"><![CDATA[<p>Swift 5.9 has enabled direct interop with C++. This means you can directly call and interact with C++, as well as introduced a series of objects that allow to interact with integral and C++ class values directly (e.g. <code class="language-plaintext highlighter-rouge">std::string</code>).</p>

<p>In order to enable the C++ interop, you need to be on XCode 15 (I think), and your projects needs to be Swift enabled. If you are not sure, you only need to add a Swift file and the bridging header will be created for you and all the Swift build settings will be enabled on XCode.</p>

<p>Afterwards you need to go into the <code class="language-plaintext highlighter-rouge">Build Settings</code> → <code class="language-plaintext highlighter-rouge">Swift Compiler - Language</code> → <code class="language-plaintext highlighter-rouge">C++ and Obj-C++ Interoperability</code> and change the value from C to C++</p>

<p>If you want to do the same in a CocoaPods project you need to modify the pod config like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">s</span><span class="p">.</span><span class="nf">pod_target_xcconfig</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'SWIFT_OBJC_INTEROP_MODE'</span> <span class="o">=</span> <span class="s1">'objcxx'</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Clang has issues with headers (it generates a module map, topic for another day). Instead of importing headers directly from your dependency, you should import the umbrella header.</p>

<pre><code class="language-C++">#import &lt;jsi/jsi.h&gt;
</code></pre>

<p>You should import everything with</p>

<pre><code class="language-C++">#import &lt;mypod-umbrella.h&gt;
</code></pre>

<p>Afterwards you are in the clear, you should be able to call any C++ function/class from your Swift code and viceversa.</p>]]></content><author><name>Oscar Franco</name></author><category term="post" /><summary type="html"><![CDATA[Swift 5.9 has enabled direct interop with C++. This means you can directly call and interact with C++, as well as introduced a series of objects that allow to interact with integral and C++ class values directly (e.g. std::string).]]></summary></entry><entry><title type="html">Get iOS simulator local home folder on macOS</title><link href="https://ospfranco.com/post/2023/11/13/get-ios-simulator-local-home-folder-on-macos/" rel="alternate" type="text/html" title="Get iOS simulator local home folder on macOS" /><published>2023-11-13T00:00:00+01:00</published><updated>2023-11-13T00:00:00+01:00</updated><id>https://ospfranco.com/post/2023/11/13/get%20ios%20simulator%20local%20home%20folder%20on%20macos</id><content type="html" xml:base="https://ospfranco.com/post/2023/11/13/get-ios-simulator-local-home-folder-on-macos/"><![CDATA[<p>Sometimes you want to really see what is on the file system of iOS. Even the simulator file system is useful to check if files are correctly downloaded or sometimes you might want to check a database file manually.</p>

<p>You can easily get the directory printed out from the XCode console. When you application is paused or a debugger breakpoint is hit, you can type <code class="language-plaintext highlighter-rouge">po NSHomeDirectory()</code> and it will print out the local directory.</p>

<p><img src="https://ospfranco.com/assets/pohomedirectory.png" alt="home directory print out" title="PO NSHomeDirectory" /></p>]]></content><author><name>Oscar Franco</name></author><category term="post" /><summary type="html"><![CDATA[Sometimes you want to really see what is on the file system of iOS. Even the simulator file system is useful to check if files are correctly downloaded or sometimes you might want to check a database file manually.]]></summary></entry><entry><title type="html">SQLite for React Native, but 5x faster and 5x less memory</title><link href="https://ospfranco.com/post/2023/11/09/sqlite-for-react-native,-but-5x-faster-and-5x-less-memory/" rel="alternate" type="text/html" title="SQLite for React Native, but 5x faster and 5x less memory" /><published>2023-11-09T00:00:00+01:00</published><updated>2023-11-09T00:00:00+01:00</updated><id>https://ospfranco.com/post/2023/11/09/sqlite%20for%20react%20native,%20but%205x%20faster%20and%205x%20less%20memory</id><content type="html" xml:base="https://ospfranco.com/post/2023/11/09/sqlite-for-react-native,-but-5x-faster-and-5x-less-memory/"><![CDATA[<p>I created a new sqlite module for react-native: <a href="https://github.com/OP-Engineering/op-sqlite">op-sqlite</a>. Although it started as some exploration of possibilities, the performance gains where so large that it turned out to be a entire re-write of the module.</p>

<h1 id="quick-sqlite">quick-sqlite</h1>

<p>I wrote <a href="https://github.com/ospfranco/react-native-quick-sqlite">quick-sqlite</a> last year after I learned about React Native JSI, a way to bridge C++ code to JavaScript. The idea was simple and I took a peek at existing libraries. One basically takes the arguments passed from JavaScript, and then just call the SQLite APIs, then collect the results of the queries and pass them back to JavaScript.</p>

<p>quick-sqlite already produced a major improvement in performance over the old bridge modules, where data had to be serialized to JSON and then passed between native and JavaScript. The flow was pretty simple:</p>

<p><img src="https://ospfranco.com/assets/quick-sqlite-flow.png" alt="quick-sqlite-flow" title="Quick SQLite flow" /></p>

<h1 id="where-quick-sqlite-fell-short">Where quick-sqlite fell short</h1>

<p>There were, however, some issues with quick-sqlite. People complained although it was fast, queries would run out of memory or it would not be fast enough. Given that this was open source work and I already gotten what I wanted I did not pursue further optimizations further. At some point it was not fun and I handed over quick-sqlite to Margelo and went for a long vacation.</p>

<p>I’ve been back at work for a few months and I have seen the value quick-sqlite provides to companies large and small. But people <a href="https://github.com/margelo/react-native-quick-sqlite/pull/30#issuecomment-1801378465">kept asking if it could be made faster</a>. They already had some good ideas: try to reduce the amount of created strings, use HostObjects to reduce memory foot-print, and so on. Just out of curiosity I decided to try a few things.</p>

<p>In order to really see differences, I set up a test of a database of 300k records, mix of strings, ints and doubles. At lower scales the differences might be so tiny that they don’t really matter.</p>

<h1 id="migrate-to-hostobjects">Migrate to HostObjects</h1>

<p>The first obvious idea was migrating to HostObjects (if you don’t know what they are, <a href="https://www.youtube.com/watch?v=_BNinSbzZTE">I made a video about them</a>, but think C++ classes bridged to JS). HostObjects are not a cure to all, but they would immediately provide a big benefit: memory consumption would be reduced. On the old flow, I would get the results from SQLite, store them in a vector, and then when I got access to the JS context again, iterate and recreate all the data again in JSI (read: plain JS) objects. This meant that all the price of converting/transfering data from native to JS, was paid upfront. By using HostObjects one can avoid paying this price of copying strings and other values. They would be created once and then stored in memory, when the JS side reaches inside them then they do the conversion of data at that point in time.</p>

<p>It is not perfect, since I’m shifting the price paid before upfront into some cost when accessing the data. But testing showed that access was just the same, and memory consumption was halved! This meant queries that would OOM before now could be run without problem.</p>

<h1 id="get-rid-of-holding-struct">Get rid of holding struct</h1>

<p>Another issue was I created a Struct to hold different type of data, due to the nature of JS any value you receive can be of these types:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="nc">QuickValue</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">intVal</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">doubleVal</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">strVal</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">boolVal</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">type</span><span class="p">;</span> <span class="c1">// used to store which type of data this was holding</span>
<span class="p">}</span>
</code></pre></div></div>

<p>There is no justification for this structure other than: I didn’t knew any better, my c++-fu was weak. I knew that using this struct would allocate too much extra memory and was wasteful, I just didn’t imagine how much. Allocating memory and moving objects around in the heap has a big cost, not only in memory but sometimes in performance!</p>

<p>When browsing the web and other peoples code, I came to learn about <a href="https://en.cppreference.com/w/cpp/utility/any">std::any</a>, which was introduced in C++ 17. It basically functions the same as my struct to hold data (internally it just stores a pointer <code class="language-plaintext highlighter-rouge">void *</code>). I got rid of the struct and swapped all references for <code class="language-plaintext highlighter-rouge">std::any</code> and the performance gains were amazing, all of the sudden the performance of the module was 3x as fast. It came with a cost however. <code class="language-plaintext highlighter-rouge">std::any</code> is awkward to use, it doesn’t really store any type information, and at best you can only run code when you know the type of the thing you put in there.</p>

<p>When reading on how to do certain operations, a lot of answers pointed towards <a href="https://en.cppreference.com/w/cpp/utility/variant">std::variant</a>. After getting the code to compile with <code class="language-plaintext highlighter-rouge">std::any</code> I decided to give <code class="language-plaintext highlighter-rouge">std::variant</code> a try. Although on the surface it looked the same, it is bounded to types one declared, because it cannot hold any type of data, the compiler can get a little smarter about it. The performance gain was also staggering here, all of the sudden I was almost reaching 6x times the performance.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;variant&gt;</span><span class="cp">
</span>
<span class="k">struct</span> <span class="nc">ArrayBuffer</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span> <span class="n">data</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">using</span> <span class="n">JSVariant</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">variant</span><span class="o">&lt;</span><span class="n">nullptr_t</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">double</span><span class="p">,</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">ArrayBuffer</span><span class="o">&gt;</span><span class="p">;</span>
</code></pre></div></div>

<h1 id="turning-the-problem-around">Turning the problem around</h1>

<p>I had a nagging feeling that somehow I was just wasting so much memory by creating HostObjects that are basically maps, therefore store the same keys over and over again (remember, I switched from creating JS objects to keeping them in HostObjects, but each HostObject contained the same keys). Then I realized I could turn the entire thing around. Instead of thinking of each HostObject as a completely stand alone entity, they could all share the same key set, and only store the actual values!</p>

<p>It took a little while for me to wrap my head around shared pointers. How to store the key set in a vector, that by using a shared_pointer in the HostObjects instances would not get de-allocated. The final result is a combination of what I call a <a href="https://github.com/OP-Engineering/op-sqlite/blob/main/cpp/DumbHostObject.h">DumbHostObject</a> and <a href="https://github.com/OP-Engineering/op-sqlite/blob/main/cpp/DynamicHostObject.cpp">DynamicHostObject</a>, the dumb objects only hold data, and the dynamic objects can hold anything (that can also be accessed from the JS side), but by combining the two, one can save memory by sharing the key set (in a DynamicHostObject) among many results (DumbHostObjects).</p>

<p>As it turns out, this slightly decreased performance (completely unexpected, who would have thought passing shared pointers around was so expensive), but memory allocation was halved again! That in my opinion is a worthy trade. The original query in quick-sqlite took over two seconds and required 1.2 gbs in memory on iOS. This now runs in ~500ms and requires only 250mbs of memory. The Android performance gains are masive as well, reaching almost 8x the speed.</p>

<table>
  <thead>
    <tr>
      <th>Library</th>
      <th>iPhone 15 Pro</th>
      <th>Galaxy S22</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>quick-sqlite</td>
      <td>2719ms</td>
      <td>8851ms</td>
    </tr>
    <tr>
      <td>expo-sqlite</td>
      <td>2293ms</td>
      <td>10626ms</td>
    </tr>
    <tr>
      <td>op-sqlite</td>
      <td>507ms</td>
      <td>1125ms</td>
    </tr>
  </tbody>
</table>

<h1 id="troubles-in-paradise">Troubles in paradise</h1>

<p>Remember what I said that HostObjects are not perfect? Turns out property access is quite slow, not only because the objects store the keys in a Vector (I tried an <code class="language-plaintext highlighter-rouge">std::unordered_map</code>, it’s even slower, hashing functions and memory layout uh?). So in a way I’m bullshitting you a bit. When running a 300k query, this numbers are fantastic, but if you are running something that returns a couple of hundred of results, you might see no difference at all.</p>

<p>As it turns out, this slow access, might not be even related to the HostObject itself, but any object that is created with the <code class="language-plaintext highlighter-rouge">jsi::Object()</code> API, when I tested <code class="language-plaintext highlighter-rouge">quick-sqlite</code> the numbers accessing data are quite similar. <code class="language-plaintext highlighter-rouge">expo-sqlite</code> was super fast on accessing data, but it zips the data on the JS side, so it seems that is the only way to create fast access objects. This means however you will always pay the price upfront for such large queries.</p>

<p>There are a few final optimizations that can be done, such as inserting keys in the shared vector with some sorting, so then accessing can be done via binary search, but I will leave it for later. Other optimizations include trying to inline more functions, but I think I have reached the end of what is possible with the JSI.</p>

<p>The next big step in performance will come from Static Hermes, where we can finally call SQLite code directly from JS without the need of HostObjects, shared pointers and so on. There will be one major difficulty though, static hermes is still single threaded, so getting React Native to call large queries without hanging will require creating a multi-threaded messaging system, AKA web-workers. I would definetely would like to tackle this problem and then create a new version of op-sqlite with that!</p>]]></content><author><name>Oscar Franco</name></author><category term="post" /><summary type="html"><![CDATA[I created a new sqlite module for react-native: op-sqlite. Although it started as some exploration of possibilities, the performance gains where so large that it turned out to be a entire re-write of the module.]]></summary></entry><entry><title type="html">Advanced C++ notes</title><link href="https://ospfranco.com/post/2023/11/08/advanced-c++-notes/" rel="alternate" type="text/html" title="Advanced C++ notes" /><published>2023-11-08T14:00:00+01:00</published><updated>2023-11-08T14:00:00+01:00</updated><id>https://ospfranco.com/post/2023/11/08/advanced%20c++%20notes</id><content type="html" xml:base="https://ospfranco.com/post/2023/11/08/advanced-c++-notes/"><![CDATA[<h1 id="noteworthy-types">Noteworthy Types</h1>

<p><code class="language-plaintext highlighter-rouge">uint8_t</code> = <code class="language-plaintext highlighter-rouge">byte</code> = a type of unsigned integer of length 8 bits</p>

<h1 id="references">References</h1>

<h2 id="printf">Printf</h2>

<p><code class="language-plaintext highlighter-rouge">printf</code> is legacy C, type unsafe, meaning you should REALLY NOT USE IT. <code class="language-plaintext highlighter-rouge">cout</code> seems to be accepted but android logging does not use it.</p>

<blockquote>
  <p>💡 printing a <code class="language-plaintext highlighter-rouge">size_t</code> is done via <code class="language-plaintext highlighter-rouge">printf(”%zu”, sizeVar)</code></p>
</blockquote>

<h2 id="define-pre-processors">DEFINE pre-processors</h2>

<p>In various C code, I see constants defined like this:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define T 100
</span></code></pre></div></div>

<p>Whereas in C++ examples, it is almost always:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="kt">int</span> <span class="n">T</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
</code></pre></div></div>

<p><strong>THEY ARE BAD PRACTICE IN C++</strong></p>

<p>Because all macros (which are what <code class="language-plaintext highlighter-rouge">#define</code>s define) are in a single namespace and they take effect everywhere. Variables, including <code class="language-plaintext highlighter-rouge">const</code>-qualified variables, can be encapsulated in classes and namespaces.</p>

<p>Macros are used in C because in C, a <code class="language-plaintext highlighter-rouge">const</code>-qualified variable is not actually a constant, it is just a variable that cannot be modified. A <code class="language-plaintext highlighter-rouge">const</code>-qualified variable cannot appear in a constant expression, so it can’t be used as an array size, for example.</p>

<p>In C++, a <code class="language-plaintext highlighter-rouge">const</code>-qualified object that is initialized with a constant expression (like <code class="language-plaintext highlighter-rouge">const int x = 5 * 2;</code>) <em>is</em> a constant and can be used in a constant expression, so you can and should use them.</p>

<h1 id="libraries">Libraries</h1>

<p>After your code is compiled to a static lib (<code class="language-plaintext highlighter-rouge">.a</code> on macOS and <code class="language-plaintext highlighter-rouge">.so</code> on linux)</p>

<p>One useful tool is <code class="language-plaintext highlighter-rouge">nm</code>. Displays the symbol label inside of your so file, which is useful for debugging any missing symbols.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nm <span class="nt">-gDC</span> myLibrary.so
</code></pre></div></div>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">-g</code> Displays only global (external) symbols</p>
</blockquote>

<p>Each symbol name is preceded by its value, followed by the following description character:</p>

<table>
  <thead>
    <tr>
      <th>Symbol</th>
      <th>Object</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>U</td>
      <td>undefined</td>
    </tr>
    <tr>
      <td>A</td>
      <td>absolute</td>
    </tr>
    <tr>
      <td>T</td>
      <td>text section symbol</td>
    </tr>
    <tr>
      <td>D</td>
      <td>data selection symbol</td>
    </tr>
    <tr>
      <td>B</td>
      <td>bss section symbol</td>
    </tr>
    <tr>
      <td>C</td>
      <td>common symbol</td>
    </tr>
    <tr>
      <td>-</td>
      <td>Debugger symbol entries (only with -a)</td>
    </tr>
    <tr>
      <td>S</td>
      <td>Symbol in a section other than those above(???)</td>
    </tr>
    <tr>
      <td>I</td>
      <td>indirect symbol</td>
    </tr>
  </tbody>
</table>

<p>If the symbol is local (non-external), the symbol’s type is instead represented by the corresponding lower case letter. A lowercase <code class="language-plaintext highlighter-rouge">u</code> in a dynamic shared library indicates an undefined reference to a private external in another module in the same library. Meaning your symbol is missing in the headers and cannot be linked/called.</p>

<p>If the symbol is a Objective-C method, the symbol name is <code class="language-plaintext highlighter-rouge">±[Class_name(category_name) method:name:]</code>, where <code class="language-plaintext highlighter-rouge">+</code> is for class methods, <code class="language-plaintext highlighter-rouge">-</code> is for instance
methods, and (category_name) is present only when the method is in a category.</p>

<h1 id="type-aliases">Type aliases</h1>

<p>The old c style of introducing a type-alias is via <code class="language-plaintext highlighter-rouge">typedef</code></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">vec</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">vInt</span><span class="p">;</span>
</code></pre></div></div>

<p>Starting in C++ 11 the <code class="language-plaintext highlighter-rouge">using</code> keyword was introduced</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="n">vInt</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">vec</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">;</span>
</code></pre></div></div>

<h1 id="virtual-functions">Virtual functions</h1>

<p>Virtual function is a member function that we expect to redefine in a derived class. It ensures <strong>overriding</strong> even if you cast a pointer to the base class.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Base</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">print</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Base function"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">Derived</span><span class="o">:</span> <span class="k">public</span> <span class="n">Base</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">print</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"derived function"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">Derived</span> <span class="n">d</span><span class="p">;</span>

    <span class="n">Base</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">derived</span><span class="p">;</span>

    <span class="n">b</span><span class="o">-&gt;</span><span class="n">print</span><span class="p">();</span> <span class="c1">// prints "derived function"</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="smart-pointers">Smart pointers</h1>

<p>Whenever the context where you create the variables ends, the variables you created will get de-allocated. This is a big problem if you want to keep resources alive. e.g.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">function</span> <span class="nf">foo</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">a</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">};</span>
    <span class="p">...</span>
    <span class="c1">// function ends, a gets de-allocated</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Smart pointers will help you keep things alive depending on how you want to keep those objects alive</p>

<h2 id="unique-pointer">Unique pointer</h2>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">p</span><span class="p">(</span><span class="k">new</span> <span class="kt">int</span><span class="p">);</span>
<span class="c1">// p &lt;--------&gt;  object</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">p</code> owns the object and the object has only one owner, <code class="language-plaintext highlighter-rouge">p</code>. A unique pointer cannot be copied or passed by value. However, the ownership of its object can be transferred.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">auto</span> <span class="n">q</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">();</span> <span class="c1">// q created with an int object on the heap</span>
<span class="k">auto</span> <span class="n">p</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">q</span><span class="p">);</span> <span class="c1">// p owns the q's object, q lost it (null pointer).</span>
</code></pre></div></div>

<p>Here is a more complete example</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;memory&gt;</span><span class="cp">
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="k">struct</span> <span class="nc">A</span><span class="p">{</span>
    <span class="o">~</span><span class="n">A</span><span class="p">(){</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Deleted."</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">PassIn</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">cout</span><span class="o">&lt;&lt;</span> <span class="s">"Pointer received."</span><span class="o">&lt;&lt;</span><span class="sc">'\n'</span><span class="p">;</span>

<span class="p">}</span> <span class="c1">// a and its object are deleted.</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>

    <span class="k">auto</span> <span class="n">x</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="p">();</span>
    <span class="n">PassIn</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="c1">// Pointer received.</span>
    <span class="p">;</span> <span class="c1">// Deleted.</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="p">)</span> <span class="n">cout</span><span class="o">&lt;&lt;</span> <span class="s">"x is empty."</span><span class="p">;</span> <span class="c1">// true: x is empty.</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>A unique pointer is useful if you want to <strong>ensure</strong> only a single copy of your data is kept alive in your code. Once somebody has taken over the pointer (via std::move) the previous reference/owner will completely loose it.</p>

<h2 id="shared-pointer">Shared pointer</h2>

<p>A shared pointer is useful when you want to keep data around as long as any of the owners of the data are alive (e.g. multiple lamdas or multiple objects pointing to a common shared object). The semantics of passing a shared pointer however are subtle and prone to errors.</p>

<h3 id="pass-by-value">Pass by value</h3>

<p>Passing a shared pointer by value will actually add an owner to the pointee (keeping it alive) and is the main use case. In the following code, the vector <code class="language-plaintext highlighter-rouge">a</code> will have the count of owners bumped when foo is called and decreased when <code class="language-plaintext highlighter-rouge">foo</code> finishes running. So the semantics don’t change.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">function</span> <span class="nf">foo</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span> <span class="n">ints</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Do something with ints</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span> <span class="n">a</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">};</span>

    <span class="n">foo</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>But if you would have a long lived structure and you pass the pointer too it, then the vector will be kept alive as long as the struct is also alive:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">A</span> <span class="p">{</span>

    <span class="c1">// You get a shared vector from some external source</span>
    <span class="c1">// as long as the instance of this class is alive then a will also be kept alive</span>
    <span class="n">A</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="o">-&gt;</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span> <span class="n">a</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>There is a small price to performance price to pay when owning the pointer. So if you only need to access it but not copy it you can pass by reference or by passing the underlaying pointer</p>

<h3 id="pass-by-reference">Pass by reference</h3>

<p>Passing by reference does not increase the owner count, you can however create a shared pointer and become an owner. The benefit of not taking ownership is that you don’t pay the price of copying and owning the shared pointer.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Does not take ownership (copy the std::shared_ptr) only uses it while this function is alive</span>
<span class="n">function</span> <span class="nf">foo</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span> <span class="o">&amp;</span><span class="n">ints</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Do something with ints</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span> <span class="n">a</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">};</span>

    <span class="n">foo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="pass-the-underlaying-pointer">Pass the underlaying pointer</h3>

<p>Similar to passing by reference except you cannot create a shared_ptr (doing so will create a new shared_ptr but will not increase the owner count)</p>

<h3 id="lambdas">Lambdas</h3>

<p>With this the capture semantics of lambdas are much clearer:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span> <span class="n">a</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">};</span>

<span class="c1">// Because a is a shared pointer, it will not be de-allocated until myLambda itself is de-allocated, which could be much later down the life of the program</span>
<span class="k">auto</span> <span class="n">myLambda</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">]()</span> <span class="p">{</span>
    <span class="c1">// Do something with a</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="weak-pointer">Weak pointer</h2>

<p>A weak pointer is a smart pointer that does not take ownership of an object but act as an observer. It’s used to observe the object of a shared pointer. It does not participate in reference counting. Weak pointers are mainly used to break circular dependencies.</p>

<h1 id="type-aliases-1">Type Aliases</h1>

<p>On C++ 11, the keyword is <code class="language-plaintext highlighter-rouge">using</code></p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// C++11</span>
<span class="nx">using</span> <span class="nx">counter</span> <span class="o">=</span> <span class="nx">long</span><span class="p">;</span>

<span class="c1">// C++03 equivalent:</span>
<span class="nx">typedef</span> <span class="nx">long</span> <span class="nx">counter</span><span class="p">;</span>
</code></pre></div></div>

<h1 id="null-vs-nullptr">NULL vs nullptr</h1>

<p><code class="language-plaintext highlighter-rouge">NULL</code> is C legacy, <code class="language-plaintext highlighter-rouge">nullptr</code>` is idiomatic C++. Null is convertible to integral types (int, bool, etc) whereas nullptr is not</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="err">✅</span>
<span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span> <span class="err">❌</span> <span class="c1">// it is however castable to bool</span>
</code></pre></div></div>

<p>The reason why NULL is legacy is because it causes ambiguity when functions are overriden.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// this both match calling a(NULL);</span>

<span class="n">function</span> <span class="n">a</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">...</span>

<span class="n">function</span> <span class="n">a</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">s</span><span class="p">)</span> <span class="p">...</span>
</code></pre></div></div>

<h1 id="stdany-and-stdvariant">std::any and std::variant</h1>

<h2 id="stdany">std::any</h2>

<p>Sometimes you don’t know which object you are going to receive. Starting on C++ you can use <code class="language-plaintext highlighter-rouge">std::any</code>. <code class="language-plaintext highlighter-rouge">std::any</code> is basically a pointer and a type information, you could do the same yourself but you can type cast to anything and get into trouble, while <code class="language-plaintext highlighter-rouge">std::any</code> can prevent you from gunfoot. It is useful to pass data data around to which you don’t know the exact type/size and you don’t care until it is time to cast it and do something useful with it. You can imagine how this is super useful with dealing with JS values that can have anything inside of them.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">std</span><span class="o">::</span><span class="n">any</span> <span class="n">myAnyInt</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">any</span> <span class="n">myAnyStr</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">"this is a string"</span><span class="p">);</span>
</code></pre></div></div>

<p>The problem with <code class="language-plaintext highlighter-rouge">std::any</code> however is you can only run code if you know the type ahead of time (read in your head and not in runtime). You can try to do casting and comparissons but it’s kinda shit.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">std</span><span class="o">::</span><span class="n">any</span> <span class="n">myAny</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

<span class="c1">// Later down the line</span>
<span class="k">if</span><span class="p">(</span><span class="n">myAny</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="k">typeid</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">myInt</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">any_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">myAny</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// You cannot really check the type of the thing you held if not by raw comparisson</span>
<span class="c1">// and the types you get are implementation dependent</span>

<span class="k">struct</span> <span class="nc">A</span> <span class="p">{}</span>

<span class="n">std</span><span class="o">::</span><span class="n">any</span> <span class="n">myA</span> <span class="o">=</span> <span class="n">A</span><span class="p">();</span>

<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">myA</span><span class="p">.</span><span class="n">type</span><span class="p">().</span><span class="n">name</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span> <span class="c1">// Might output "x"</span>
</code></pre></div></div>

<h2 id="stdvariant">std::variant</h2>

<p>If you already know what your bag of holding will hold you can use std::variant. It is much better because it will only accept a set of types you define. It will also apply compiler optimizations.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="n">MyBagOfHolding</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">variant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">double</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">nullptr_t</span><span class="o">&gt;</span><span class="p">;</span>

<span class="n">MyBagOfHolding</span> <span class="n">bag</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

<span class="c1">// .. much later down in the code</span>

<span class="k">if</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">holds_alternative</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">bag</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">bag</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This example is simple and might look as good as <code class="language-plaintext highlighter-rouge">std::any</code>, but the compiler optimizations and the type warnings are worth it on it’s own.</p>

<h1 id="object-initialization">Object initialization</h1>

<p>There is only one way to initialize class consts or reference members, using the the <code class="language-plaintext highlighter-rouge">initialization list</code> syntax. It initializes the variables of an instance before the body of the constructor is called</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Demo</span>
<span class="p">{</span>
    <span class="nc">Demo</span><span class="p">(</span><span class="nx">int</span><span class="o">&amp;</span> <span class="nx">val</span><span class="p">)</span> <span class="p">:</span> <span class="nf">m_val</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>
     <span class="p">{</span>
     <span class="p">}</span>
<span class="nl">private</span><span class="p">:</span>
    <span class="kd">const</span> <span class="nx">int</span><span class="o">&amp;</span> <span class="nx">m_val</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<h2 id="destructor">Destructor</h2>

<p>You can execute code after an object has been destructured</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// dispatch_queue.h</span>
<span class="k">class</span> <span class="nc">dispatch_queue</span> <span class="p">{</span>

<span class="nl">public:</span>
<span class="c1">// Explicit constructor (does not allow for argument implicit conversion)</span>
<span class="k">explicit</span> <span class="n">dispatch_queue</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">thread_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">);</span>
<span class="c1">// Destructor</span>
<span class="o">~</span><span class="n">dispatch_queue</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>]]></content><author><name>Oscar Franco</name></author><category term="post" /><summary type="html"><![CDATA[Noteworthy Types]]></summary></entry><entry><title type="html">Cocoapods, use_frameworks with static linking</title><link href="https://ospfranco.com/post/2023/10/15/cocoapods,-use_frameworks-with-static-linking/" rel="alternate" type="text/html" title="Cocoapods, use_frameworks with static linking" /><published>2023-10-15T15:00:00+02:00</published><updated>2023-10-15T15:00:00+02:00</updated><id>https://ospfranco.com/post/2023/10/15/cocoapods,%20use_frameworks%20with%20static%20linking</id><content type="html" xml:base="https://ospfranco.com/post/2023/10/15/cocoapods,-use_frameworks-with-static-linking/"><![CDATA[<p><code class="language-plaintext highlighter-rouge">use_frameworks!</code> tells CocoaPods that you want to use XCFrameworks instead of Static Libraries. However, turning on use_frameworks will try to link all dependencies as dynamic, every once in a while you might need to turn it on and might face compilation error in some other library (e.g. vision-camera).</p>

<p>In this case, you can actually use frameworks, yet still force static compiling. Replace</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">use_frameworks!</span>
</code></pre></div></div>

<p>with</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">use_frameworks!</span> <span class="ss">linkage: :static</span>
</code></pre></div></div>

<h1 id="xcframeworks">XCFrameworks</h1>

<p>In case you didn’t know frameworks are just an Apple concept to package different architectures into a single file. Nothing fancy to it. Inside the <code class="language-plaintext highlighter-rouge">.xcframework</code> file you might find folders per architecture and a <code class="language-plaintext highlighter-rouge">.plist</code> file.</p>]]></content><author><name>Oscar Franco</name></author><category term="post" /><summary type="html"><![CDATA[use_frameworks! tells CocoaPods that you want to use XCFrameworks instead of Static Libraries. However, turning on use_frameworks will try to link all dependencies as dynamic, every once in a while you might need to turn it on and might face compilation error in some other library (e.g. vision-camera).]]></summary></entry><entry><title type="html">React Native load release bundle in iOS dev app</title><link href="https://ospfranco.com/post/2023/10/12/react-native-load-release-bundle-in-ios-dev-app/" rel="alternate" type="text/html" title="React Native load release bundle in iOS dev app" /><published>2023-10-12T15:00:00+02:00</published><updated>2023-10-12T15:00:00+02:00</updated><id>https://ospfranco.com/post/2023/10/12/react%20native%20load%20release%20bundle%20in%20ios%20dev%20app</id><content type="html" xml:base="https://ospfranco.com/post/2023/10/12/react-native-load-release-bundle-in-ios-dev-app/"><![CDATA[<p>When using React Native on Android you can enter the dev menu and choose not to use a development JS bundle. Usually useful to catch performance regressions in your JS code. For iOS this option is not present on the dev menu, but you can still achieve it if you hack around the native code.</p>

<p>In your AppDelegate, replace</p>

<div class="language-obj-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">return</span> <span class="p">[[</span><span class="n">RCTBundleURLProvider</span> <span class="nf">sharedSettings</span><span class="p">]</span> <span class="nf">jsBundleURLForBundleRoot</span><span class="p">:</span><span class="s">@"index"</span><span class="p">];</span>
</code></pre></div></div>

<p>with</p>

<div class="language-obj-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">NSString</span> <span class="o">*</span><span class="n">packagerServerHostPort</span> <span class="o">=</span> <span class="p">[[</span><span class="n">RCTBundleURLProvider</span> <span class="nf">sharedSettings</span><span class="p">]</span> <span class="nf">packagerServerHostPort</span><span class="p">];</span>
<span class="k">return</span> <span class="p">[</span><span class="n">RCTBundleURLProvider</span> <span class="nf">jsBundleURLForBundleRoot</span><span class="p">:</span><span class="s">@"index"</span>
                                         <span class="nl">packagerHost:</span><span class="n">packagerServerHostPort</span>
                                            <span class="nl">enableDev:</span><span class="nb">NO</span>
                                   <span class="nl">enableMinification:</span><span class="nb">NO</span><span class="p">];</span>
</code></pre></div></div>]]></content><author><name>Oscar Franco</name></author><category term="post" /><summary type="html"><![CDATA[When using React Native on Android you can enter the dev menu and choose not to use a development JS bundle. Usually useful to catch performance regressions in your JS code. For iOS this option is not present on the dev menu, but you can still achieve it if you hack around the native code.]]></summary></entry><entry><title type="html">Add gap support to Native Wind 2.x.x</title><link href="https://ospfranco.com/post/2023/08/21/add-gap-support-to-native-wind-2.x.x/" rel="alternate" type="text/html" title="Add gap support to Native Wind 2.x.x" /><published>2023-08-21T15:00:00+02:00</published><updated>2023-08-21T15:00:00+02:00</updated><id>https://ospfranco.com/post/2023/08/21/add%20gap%20support%20to%20native%20wind%202.x.x</id><content type="html" xml:base="https://ospfranco.com/post/2023/08/21/add-gap-support-to-native-wind-2.x.x/"><![CDATA[<p>I’m a big fan of Tailwind CSS. On React Native I use Nativewind.</p>

<p>There is however a small problem with the 2.X.X version of Nativewind, it doesn’t support the <code class="language-plaintext highlighter-rouge">gap</code> property, which was added on RN 0.70.</p>

<p>We can however patch this functionality (without using the unstable 3.x.x branch).</p>

<p>Add the following to <code class="language-plaintext highlighter-rouge">tailwind.config.js</code></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/** @type {import('tailwindcss').Config} */</span>

<span class="kd">const</span> <span class="nx">plugin</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">tailwindcss/plugin</span><span class="dl">"</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">content</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">./App.tsx</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">./src/**/*.{ts,tsx}</span><span class="dl">"</span><span class="p">],</span>
  <span class="na">theme</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">g</span><span class="p">:</span> <span class="p">({</span> <span class="nx">theme</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="nf">theme</span><span class="p">(</span><span class="dl">"</span><span class="s2">spacing</span><span class="dl">"</span><span class="p">),</span> <span class="c1">// ADD THIS FUNCTION</span>
    <span class="na">extend</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">colors</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">lightPurple</span><span class="p">:</span> <span class="dl">"</span><span class="s2">#6360EB</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">darkPurple</span><span class="p">:</span> <span class="dl">"</span><span class="s2">#001448</span><span class="dl">"</span><span class="p">,</span>
      <span class="p">},</span>
    <span class="p">},</span>
  <span class="p">},</span>
  <span class="na">plugins</span><span class="p">:</span> <span class="p">[</span>
    <span class="nf">plugin</span><span class="p">(</span><span class="nf">function </span><span class="p">({</span> <span class="nx">matchUtilities</span><span class="p">,</span> <span class="nx">theme</span> <span class="p">})</span> <span class="p">{</span>
      <span class="c1">// ADD THIS PLUGIN</span>
      <span class="nf">matchUtilities</span><span class="p">(</span>
        <span class="p">{</span>
          <span class="na">g</span><span class="p">:</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">({</span>
            <span class="na">gap</span><span class="p">:</span> <span class="nx">value</span><span class="p">,</span>
          <span class="p">}),</span>
        <span class="p">},</span>
        <span class="p">{</span> <span class="na">values</span><span class="p">:</span> <span class="nf">theme</span><span class="p">(</span><span class="dl">"</span><span class="s2">g</span><span class="dl">"</span><span class="p">)</span> <span class="p">}</span>
      <span class="p">);</span>
    <span class="p">}),</span>
  <span class="p">],</span>
<span class="p">};</span>
</code></pre></div></div>

<h1 id="use-patch-package-to-patch-the-list-of-supported-properties">Use patch-package to patch the list of supported properties</h1>

<p>Internally Nativewind maintains a list of supported properties, and gap is not among them, so we are going to have to <code class="language-plaintext highlighter-rouge">patch-package</code> it. Create a patch <code class="language-plaintext highlighter-rouge">nativewind+2.0.11.patch</code> file in your <code class="language-plaintext highlighter-rouge">patches</code> directory, with the following content:</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gh">diff --git a/node_modules/nativewind/dist/postcss/to-react-native/is-invalid-property.js b/node_modules/nativewind/dist/postcss/to-react-native/is-invalid-property.js
index 7d7715b..56472bc 100644
</span><span class="gd">--- a/node_modules/nativewind/dist/postcss/to-react-native/is-invalid-property.js
</span><span class="gi">+++ b/node_modules/nativewind/dist/postcss/to-react-native/is-invalid-property.js
</span><span class="p">@@ -1,120 +1,121 @@</span>
<span class="gd">-"use strict";
-Object.defineProperty(exports, "__esModule", { value: true });
-exports.isInvalidProperty = void 0;
</span><span class="gi">+'use strict'
+Object.defineProperty(exports, '__esModule', {value: true})
+exports.isInvalidProperty = void 0
</span> function isInvalidProperty(property) {
<span class="gd">-    return !validProps.has(property);
</span><span class="gi">+  return !validProps.has(property)
</span> }
<span class="gd">-exports.isInvalidProperty = isInvalidProperty;
</span><span class="gi">+exports.isInvalidProperty = isInvalidProperty
</span> const validProps = new Set([
<span class="gd">-    "alignContent",
-    "alignItems",
-    "alignSelf",
-    "aspectRatio",
-    "backfaceVisibility",
-    "backgroundColor",
-    "borderBottomColor",
-    "borderBottomEndRadius",
-    "borderBottomLeftRadius",
-    "borderBottomRightRadius",
-    "borderBottomStartRadius",
-    "borderBottomWidth",
-    "borderColor",
-    "borderEndColor",
-    "borderEndWidth",
-    "borderLeftColor",
-    "borderLeftWidth",
-    "borderRadius",
-    "borderRightColor",
-    "borderRightWidth",
-    "borderStartColor",
-    "borderStartWidth",
-    "borderStyle",
-    "borderTopColor",
-    "borderTopEndRadius",
-    "borderTopLeftRadius",
-    "borderTopRightRadius",
-    "borderTopStartRadius",
-    "borderTopWidth",
-    "borderWidth",
-    "bottom",
-    "color",
-    "direction",
-    "display",
-    "elevation",
-    "end",
-    "flex",
-    "flexBasis",
-    "flexDirection",
-    "flexGrow",
-    "flexShrink",
-    "flexWrap",
-    "fontFamily",
-    "fontSize",
-    "fontStyle",
-    "fontVariant",
-    "fontWeight",
-    "height",
-    "includeFontPadding",
-    "justifyContent",
-    "left",
-    "letterSpacing",
-    "lineHeight",
-    "margin",
-    "marginBottom",
-    "marginEnd",
-    "marginHorizontal",
-    "marginLeft",
-    "marginRight",
-    "marginStart",
-    "marginTop",
-    "marginVertical",
-    "maxHeight",
-    "maxWidth",
-    "minHeight",
-    "minWidth",
-    "opacity",
-    "overflow",
-    "overlayColor",
-    "padding",
-    "paddingBottom",
-    "paddingEnd",
-    "paddingHorizontal",
-    "paddingLeft",
-    "paddingRight",
-    "paddingStart",
-    "paddingTop",
-    "paddingVertical",
-    "position",
-    "resizeMode",
-    "right",
-    "rotation",
-    "scaleX",
-    "scaleY",
-    "shadowColor",
-    "shadowOffset",
-    "shadowOpacity",
-    "shadowRadius",
-    "start",
-    "textAlign",
-    "textAlignVertical",
-    "textDecorationColor",
-    "textDecorationLine",
-    "textDecorationStyle",
-    "textShadowColor",
-    "textShadowOffset",
-    "textShadowRadius",
-    "textTransform",
-    "tintColor",
-    "top",
-    "transform",
-    "transformMatrix",
-    "translateX",
-    "translateY",
-    "width",
-    "writingDirection",
-    "zIndex",
-    /* SVG Props */
-    "fill",
-    "stroke",
-    "strokeWidth",
-]);
</span><span class="gi">+  'alignContent',
+  'alignItems',
+  'alignSelf',
+  'aspectRatio',
+  'backfaceVisibility',
+  'backgroundColor',
+  'borderBottomColor',
+  'borderBottomEndRadius',
+  'borderBottomLeftRadius',
+  'borderBottomRightRadius',
+  'borderBottomStartRadius',
+  'borderBottomWidth',
+  'borderColor',
+  'borderEndColor',
+  'borderEndWidth',
+  'borderLeftColor',
+  'borderLeftWidth',
+  'borderRadius',
+  'borderRightColor',
+  'borderRightWidth',
+  'borderStartColor',
+  'borderStartWidth',
+  'borderStyle',
+  'borderTopColor',
+  'borderTopEndRadius',
+  'borderTopLeftRadius',
+  'borderTopRightRadius',
+  'borderTopStartRadius',
+  'borderTopWidth',
+  'borderWidth',
+  'bottom',
+  'color',
+  'direction',
+  'display',
+  'elevation',
+  'end',
+  'flex',
+  'flexBasis',
+  'flexDirection',
+  'flexGrow',
+  'flexShrink',
+  'flexWrap',
+  'fontFamily',
+  'fontSize',
+  'fontStyle',
+  'fontVariant',
+  'fontWeight',
+  'height',
+  'includeFontPadding',
+  'justifyContent',
+  'left',
+  'letterSpacing',
+  'lineHeight',
+  'margin',
+  'marginBottom',
+  'marginEnd',
+  'marginHorizontal',
+  'marginLeft',
+  'marginRight',
+  'marginStart',
+  'marginTop',
+  'marginVertical',
+  'maxHeight',
+  'maxWidth',
+  'minHeight',
+  'minWidth',
+  'opacity',
+  'overflow',
+  'overlayColor',
+  'padding',
+  'paddingBottom',
+  'paddingEnd',
+  'paddingHorizontal',
+  'paddingLeft',
+  'paddingRight',
+  'paddingStart',
+  'paddingTop',
+  'paddingVertical',
+  'position',
+  'resizeMode',
+  'right',
+  'rotation',
+  'scaleX',
+  'scaleY',
+  'shadowColor',
+  'shadowOffset',
+  'shadowOpacity',
+  'shadowRadius',
+  'start',
+  'textAlign',
+  'textAlignVertical',
+  'textDecorationColor',
+  'textDecorationLine',
+  'textDecorationStyle',
+  'textShadowColor',
+  'textShadowOffset',
+  'textShadowRadius',
+  'textTransform',
+  'tintColor',
+  'top',
+  'transform',
+  'transformMatrix',
+  'translateX',
+  'translateY',
+  'width',
+  'writingDirection',
+  'zIndex',
+  'gap',
+  /* SVG Props */
+  'fill',
+  'stroke',
+  'strokeWidth',
+])
</span></code></pre></div></div>

<blockquote>
  <p>Actually we only need to add gap to the list, but my formatter cleaned everything and I’m too lazy to clean it :)</p>
</blockquote>

<p>Afterwards you can run <code class="language-plaintext highlighter-rouge">yarn</code> again for the patch to take effect, restart the packager (maybe with –reset-cache) and you can now use the gap property via <code class="language-plaintext highlighter-rouge">g-[n]</code> utilities.</p>]]></content><author><name>Oscar Franco</name></author><category term="post" /><summary type="html"><![CDATA[I’m a big fan of Tailwind CSS. On React Native I use Nativewind.]]></summary></entry></feed>