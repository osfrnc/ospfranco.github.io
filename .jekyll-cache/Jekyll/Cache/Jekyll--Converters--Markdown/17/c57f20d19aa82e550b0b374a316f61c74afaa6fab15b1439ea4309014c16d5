I"Rb<p>First of all, this would not be possible without <a href="https://hswolff.com/blog/react-native-art-and-d3/">this great post</a> by Harry Wolff.</p>

<p>So, I’m currently in the middle of developing a Zettelkasten app for macOS, and basically I needed to draw a graph simulation that shows the connections between the notes/links, it’s a fairly straightforward task and I do not need to write any math code, since it is all abstracted via <a href="https://github.com/d3/d3-force">d3 force simulation</a>.</p>

<p>The problem however is that I’m using react-native-macos, and while it’s a great tool for the very short time it has existed, one of the major pain points is the lack of support of existing libraries, all the current libraries need to be ported/enabled to run on macOS.</p>

<p>Unfortunately this meant I could not use react-native-svg to draw my graphics, since support hasn’t been added yet (and it might never do, but who knows)</p>

<p>Now when I reached this point, I was ready to give up and try to somehow generate a html and pass it to a react-native-webview (it does support rn macos), but out of casuality I ran accross <a href="https://github.com/reactjs/react-art">react-ART</a>, after I asked if which were the possibilities to draw vector graphics on the official rn-macos repo, it seemed the only sane choice.</p>

<p>So here is a quick premier on how to draw vector graphics on react-native without using any external library (ART is still bundled in the latest versions) on react-native (macOS)</p>

<h2 id="art--svg-but-it-does-output-to-it">ART != SVG, but it does output to it</h2>

<p>So ReactART is its own library, while I might have a similar API to other vector drawing libraries, it’s not a 1 to 1 equivalence, it does however support passing a SVG path to it and rendering it.</p>

<p>Before we start you need to link the ART library to your project, even though it is included in the node_modules/react-native directory, it is not linked by default.</p>

<p>you can either do it via Cocoapods (add the ReactART dependency pointing to <code class="language-plaintext highlighter-rouge">../nodes_modules/react-native/ART</code>) or manually link the library (Add files to project, link with binaries, etc), not gonna go into to much detail here, if you ever linked a library you know what to do.</p>

<h2 id="simple-example">Simple example</h2>

<p>Once you have ART linked, you should be able to do a simple vector graphic test:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">React</span><span class="dl">'</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">ART</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">react-native</span><span class="dl">'</span>

<span class="kd">let</span> <span class="p">{</span><span class="nx">Surface</span><span class="p">,</span> <span class="nx">Shape</span><span class="p">,</span> <span class="nx">Path</span><span class="p">}</span> <span class="o">=</span> <span class="nx">ART</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">Foo</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">line</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Path</span><span class="p">()</span>
  <span class="nx">line</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
  <span class="nx">line</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="o">&lt;</span><span class="nx">Surface</span> <span class="nx">width</span><span class="o">=</span><span class="p">{</span><span class="mi">100</span><span class="p">}</span> <span class="nx">height</span><span class="o">=</span><span class="p">{</span><span class="mi">100</span><span class="p">}</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">Shape</span> <span class="nx">d</span><span class="o">=</span><span class="p">{</span><span class="nx">line</span><span class="p">}</span> <span class="nx">stroke</span><span class="o">=</span><span class="dl">"</span><span class="s2">#000</span><span class="dl">"</span> <span class="nx">strokeWidth</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="sr">/Surface</span><span class="err">&gt;
</span>  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>You should see a line that crosses from topleft corner to the bottomright corner</p>

<h2 id="off-to-the-races-almost">Off to the races… almost!</h2>

<p>So now that we are able to draw some graphics it’s time to draw our graph, for that we are going to use D3 force simulation, now this is the part that was a bit hard for me to understand, most of the documentation you are going to find outthere lets d3 take care of manipulating the svg elements and the dom, since this is react-native there is no dom, so we’re going to have to go around it a bit.</p>

<p>Another thing to take into account, in the original article Harry creates all the shapes in d3 and then turns them into paths for ART to render, but I find this step cumbersome (at least for this use case), so I just create the shapes myself as you will see.</p>

<p>And one last thing, I’m quite ambivalent with the use of hooks, when the use case is “simple” (that is, it’s easy to reason in a declarative manner) I believe they provide a lot of value, but in this case I struggled quite a bit trying to re-bind the corresponding functions as my data got updated, at some point I grew tired and realized it is not worth my time, therefore for this simulation I’m using a class component, feel free to create a hook version of it.</p>

<p>Ok, so now we can start, let’s first create our component and the simulation that will be in charge of the calculations:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">class</span> <span class="nx">Graph</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="c1">// any object will do, I put an id there for some application logic</span>
  <span class="c1">// since they represent another structure, you want to use that id</span>
  <span class="c1">// to later show text or other stuff</span>
  <span class="nx">graphNodes</span> <span class="o">=</span> <span class="p">[{</span> <span class="na">id</span><span class="p">:</span> <span class="s2">`1`</span> <span class="p">},</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="s2">`2`</span> <span class="p">}];</span>
  <span class="c1">// the links of the graph, source and target are needed and they don't point</span>
  <span class="c1">// to the ids, but rather to the indexes</span>
  <span class="nx">graphLinks</span> <span class="o">=</span> <span class="p">[{</span> <span class="na">source</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">target</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}];</span>
  <span class="nx">simulation</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>

    <span class="c1">// Use a closure to bind to context</span>
    <span class="c1">// no need to mess around with the state (or hooks)</span>
    <span class="c1">// the force simulation will write into the original values</span>
    <span class="c1">// we just need to render each tick</span>
    <span class="kd">const</span> <span class="nx">ticked</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">forceUpdate</span><span class="p">();</span>
    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">simulation</span> <span class="o">=</span> <span class="nx">d3</span>
      <span class="p">.</span><span class="nx">forceSimulation</span><span class="p">(</span><span class="nx">graphNodes</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">force</span><span class="p">(</span><span class="s2">`charge`</span><span class="p">,</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">forceManyBody</span><span class="p">().</span><span class="nx">strength</span><span class="p">(</span><span class="o">-</span><span class="mi">200</span><span class="p">))</span>
      <span class="p">.</span><span class="nx">force</span><span class="p">(</span><span class="s2">`link`</span><span class="p">,</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">forceLink</span><span class="p">(</span><span class="nx">graphLinks</span><span class="p">))</span>
      <span class="p">.</span><span class="nx">force</span><span class="p">(</span><span class="s2">`x`</span><span class="p">,</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">forceX</span><span class="p">())</span>
      <span class="p">.</span><span class="nx">force</span><span class="p">(</span><span class="s2">`y`</span><span class="p">,</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">forceY</span><span class="p">())</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">`tick`</span><span class="p">,</span> <span class="nx">ticked</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This is also what took me a while to understand, it doesn’t really matter which objects do you pass to the force simulation, if necessary it will inject/create all the necessary properties to run it’s simulation, now, on a lot of the code/tutorials outthere you see a lot of d3 funky manipulation (add groups, modify the <code class="language-plaintext highlighter-rouge">cx</code> and <code class="language-plaintext highlighter-rouge">cy</code> proprety) but actually none of this is needed, the force simulation will already inject all the properties and since we will render the thing ourselves then our job is pretty much done with d3 (we still need to handle updates)</p>

<p>So now we will render the output of the force simulation, on our render function:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="p">{</span><span class="nx">graphNodes</span><span class="p">,</span> <span class="nx">graphLinks</span><span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span>
  <span class="kd">let</span> <span class="nx">NODE_RADIUS</span> <span class="o">=</span> <span class="mi">6</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="o">&lt;</span><span class="nx">Surface</span> <span class="nx">width</span><span class="o">=</span><span class="p">{</span><span class="mi">400</span><span class="p">}</span> <span class="nx">height</span><span class="o">=</span><span class="p">{</span><span class="mi">400</span><span class="p">}</span><span class="o">&gt;</span>
          <span class="p">{</span><span class="nx">graphLinks</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="na">link</span><span class="p">:</span> <span class="nx">any</span><span class="p">,</span> <span class="na">ii</span><span class="p">:</span> <span class="nx">number</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">line</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Path</span><span class="p">()</span>
            <span class="nx">line</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="nx">link</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="mi">200</span><span class="p">,</span> <span class="nx">link</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="mi">200</span><span class="p">)</span>
            <span class="nx">line</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="nx">link</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="mi">200</span><span class="p">,</span> <span class="nx">link</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="mi">200</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span>
              <span class="o">&lt;</span><span class="nx">Shape</span>
                <span class="nx">d</span><span class="o">=</span><span class="p">{</span><span class="nx">line</span><span class="p">}</span>
                <span class="nx">stroke</span><span class="o">=</span><span class="p">{</span><span class="nx">linkColor</span><span class="p">}</span>
                <span class="nx">strokeWidth</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
                <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="s2">`line-</span><span class="p">${</span><span class="nx">ii</span><span class="p">}</span><span class="s2">`</span><span class="p">}</span>
              <span class="sr">/</span><span class="err">&gt;
</span>            <span class="p">)</span>
          <span class="p">})}</span>
          <span class="p">{</span><span class="nx">graphNodes</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="na">node</span><span class="p">:</span> <span class="nx">any</span><span class="p">,</span> <span class="na">ii</span><span class="p">:</span> <span class="nx">number</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="c1">// This is how you draw a circle in ART</span>
            <span class="kd">const</span> <span class="nx">circle</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Path</span><span class="p">()</span>
              <span class="p">.</span><span class="nx">arc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">NODE_RADIUS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">NODE_RADIUS</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">arc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">NODE_RADIUS</span> <span class="o">*</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="nx">NODE_RADIUS</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">(</span>
              <span class="o">&lt;</span><span class="nx">Shape</span>
                <span class="nx">fill</span><span class="o">=</span><span class="p">{</span><span class="nx">nodeColor</span><span class="p">}</span>
                <span class="nx">d</span><span class="o">=</span><span class="p">{</span><span class="nx">circle</span><span class="p">}</span>
                <span class="nx">x</span><span class="o">=</span><span class="p">{</span><span class="nx">node</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="mi">200</span><span class="p">}</span>
                <span class="nx">y</span><span class="o">=</span><span class="p">{</span><span class="nx">node</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="mi">196</span><span class="p">}</span>
                <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="s2">`circle-</span><span class="p">${</span><span class="nx">ii</span><span class="p">}</span><span class="s2">`</span><span class="p">}</span>
              <span class="sr">/</span><span class="err">&gt;
</span>            <span class="p">)</span>
          <span class="p">})}</span>
        <span class="o">&lt;</span><span class="sr">/Surface</span><span class="err">&gt;
</span>  <span class="p">)</span>
<span class="p">}</span>

</code></pre></div></div>

<p>Notice I have given the surface a height and a width of 400, the force simulation will start at 0, therefore it is only a matter of adding the center of the surface (x: 200, y: 200) as an offset to “center” our graph</p>

<p>So it’s pretty straightforward, you use the ART api to “draw” the shape (instead of using d3 as originally posted) and then simply pass it to the Shape component of ART.</p>

<p>Now there are some limitations to the ART library, basically there is no way to capture touches, so it’s not a perfect replacement for react-native-svg or other drawing libraries, but it does allow to get the job done, in this case doing a graph visualization</p>

<p>on every tick of the force simulation, the component will be re-rendered and you will get a fluid animation, here is a bit more complete implementation and how it looks like in my app:</p>

<p><img src="http://localhost:5000/assets/ARTGraph.png" alt="ART Graph" title="ART Graph" /></p>

<h2 id="handling-updates">Handling updates</h2>

<p>There is one more point that I haven’t touched yet, which is handling updates to your data and the truth is… it’s not quite working well enough for me at the moment, so that is why I left it for last</p>

<p>You could take the lazy route and re-initialize everything and let the force simulation run from the beginning, but I would like to keep the graph nodes in the same position and let the any new node just pop and squeeze itself (it helps with spacial information), here is what I got so far:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">componentWillReceiveProps</span><span class="p">({</span><span class="nx">links</span><span class="p">}:</span> <span class="nx">IProps</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="p">{</span><span class="na">links</span><span class="p">:</span> <span class="nx">oldLinks</span><span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span>
    <span class="c1">// just some performance optimization</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">links</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="nx">oldLinks</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span>
    <span class="p">}</span>

	  <span class="c1">// stop the simulation from ticking while we are updating the values</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">simulation</span><span class="p">.</span><span class="nx">stop</span><span class="p">()</span>

    <span class="kd">let</span> <span class="nx">newGraphNodes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="kd">let</span> <span class="nx">newGraphLinks</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="kd">let</span> <span class="nx">jj</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ii</span> <span class="o">&lt;</span> <span class="nx">links</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// iterate over the old array, remove any value that is not present</span>
      <span class="c1">// insert any new nodes</span>
      <span class="c1">// why? because we want to keep existing x, y information</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">jj</span> <span class="o">&lt;</span> <span class="nx">graphNodes</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">links</span><span class="p">[</span><span class="nx">ii</span><span class="p">].</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">graphNodes</span><span class="p">[</span><span class="nx">jj</span><span class="p">].</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">newGraphNodes</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">graphNodes</span><span class="p">[</span><span class="nx">jj</span><span class="p">])</span>
        <span class="p">}</span>
        <span class="nx">jj</span><span class="o">++</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">newGraphNodes</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="na">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">y</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">id</span><span class="p">:</span> <span class="nx">links</span><span class="p">[</span><span class="nx">ii</span><span class="p">].</span><span class="nx">id</span><span class="p">})</span>
      <span class="p">}</span>

      <span class="c1">// generate new newGraphLinks</span>
      <span class="c1">// TODO here you need to generate your graph links one more time</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">simulation</span>
      <span class="p">.</span><span class="nx">nodes</span><span class="p">(</span><span class="nx">newGraphNodes</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">force</span><span class="p">(</span><span class="s2">`link`</span><span class="p">,</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">forceLink</span><span class="p">(</span><span class="nx">newGraphLinks</span><span class="p">))</span>
      <span class="p">.</span><span class="nx">restart</span><span class="p">()</span>

		<span class="k">this</span><span class="p">.</span><span class="nx">graphNodes</span> <span class="o">=</span> <span class="nx">newGraphNodes</span>
  	<span class="k">this</span><span class="p">.</span><span class="nx">graphLinks</span> <span class="o">=</span> <span class="nx">newGraphLinks</span>
  <span class="p">}</span>

	<span class="c1">// To prevent annoying warnings if your component has been unmounted</span>
	<span class="c1">// and the simulation is still running</span>
  <span class="nx">componentWillUnmount</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">simulation</span><span class="p">.</span><span class="nx">stop</span><span class="p">()</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>There it is, you should now be able to draw vector graphics on rn without the need for other library, if you need interactivity… can’t be done for now, but hopefully someone will port the svg package soon for macOS.</p>

<p>Cheers</p>
:ET